
/* Implementation of RSA Algorithm  */
/* Hamad ALSHEHHI and Abderrahmane NITAJ */

#include <stdio.h>
#include <stdlib.h>
#include <gmp.h>
#include <time.h>

/* define minimum duration of each timing, and min. number of iterations */

#define MIN_TIME 5.0
#define MIN_ITERS 5 


struct rsa_public_key_t {
	mpz_t e;
	mpz_t n;
};
struct rsa_private_key_t {
	mpz_t d;
	mpz_t phi;
};


struct rsa_public_key_t pubk;
struct rsa_private_key_t pivk;


void doub_mult_algo2(  mpz_t a,mpz_t exp,mpz_t modulu, mpz_t m)
{
	mpz_init(a); 
	int loop, no_of_bits;
	no_of_bits = mpz_sizeinbase(exp, 2);
	if(mpz_cmp_ui(exp, 0) == 0)
		return;

	mpz_set_ui(a, 1);

	for(loop = no_of_bits-1; loop >= 0; loop--) {

		mpz_mul(a,a,a);
		mpz_mod(a,a,modulu);
		if(mpz_tstbit(exp, loop)){
			mpz_mul(a,a,m);
			mpz_mod(a,a,modulu);
		}
	}

}		


void doub_mult_algo(  mpz_t a,mpz_t exp,mpz_t modulu, mpz_t m)
{
	mpz_powm(a, m, exp, modulu);
}		



int main(int argc, char *argv[])
{
	int iterations=0;
	clock_t start;
	double elapsed;
	int i;
	mpz_init(pubk.e); 
	mpz_init(pubk.n);
	mpz_t m;
	mpz_init(m);
	mpz_t d;
	mpz_init(d);
	mpz_t c;
	mpz_init(c);
	mpz_t m2;
	mpz_init(m2);

	mpz_set_str(pubk.n, "389388060028787481856473050133296482237851944693983256772645835992357733128920811943168534852742498786311210133480919881270420781833762924703887557415023607292358869254640875973514424297606861373928880325327582064130701350850011212717701717771342762342841352807620780411645378538104076112699156760122974288018400001015768632520842516710033953310255467014283822197591966416744546565975352721730091179704834620241291982026409243490352307585231825097195342084954474368580442498401359885712545191146404292127692054808906243757465923851337079881809283486683830585378224704667493347981377268980606776670284680129345917680461299610531151170416796772934255609458956663691044330124684936006663802337692848489485081975516561453184699983569002035583153126924757826011280073017680915327695289031608428647670967620312266814144505213324218667548970771549727470524633037301226923788510253468942778516715132466790265700958158388723079981704253308463620985578504202350844499496552823579170364569430924555606762283017523577205214669436979825236677531972456423186947916345122411478928625710150295086263270363243354959320670563705627591864037577796964519992532373810264550782906696154555119092804727535706517994167052706328539665475840899217079587338937",0);

	mpz_set_str(m, "34798323276904195540591952932749320439928080249223614041727757131845193886948597903883744178884051887753955896326307176320326987375725384709369455468269041442088824012191547640830319887848610979174693218048147596457103289107001104469409264624706859340218698376193599219012144393064772721817478803768492925772617329539283643549122330618723311190538454741279449170850685401881709140199638050084094555946885804257318020918693951950184508852223562844955270001934971491755285685847475839185639262988688863874625862439797522746438075393983794221538034742482058488732064039834465082655337336050476456992016445783030157601890304804714161219249728837942921416336493525801029620202717041940366209470334617794960751069738383534921197116935006066933675388129778184990058432522067565859559754909482979285302222547127824889233605901116716595002489072906343656961118705340186687591416964316735266860560256143700058735440907081685434627902829312930510823680170563477217805788434953136434686914422988344187163153471277972528678133900957135688108530834208478793519964331816769646485477890081653086294689609716952373177571790672173826534875845768055242791606413136580144399189232366612331873465024908558526470982141286296728452398345746146083270053029", 0);

	mpz_mod(m,m,pubk.n);

	mpz_set_str(pubk.e, "65537", 0);
	mpz_set_str(pivk.d, "93008234916011401818533486836239424034535214340595600981415046715967590130767755468794120032727025588612778788005406408920261332054041607386890700272743328937158944402584010139148798357488713367219779553728092064511680408718831736635532640950800305197290668429291784740892881206577676846181433387597312045175092445731431743495754592925810938937069732832470191688376102694473642857374890085081142672491866901830373448382461972589498680484905000077383705158885474491749061551031858151135147816076503544394264177883922339133304416924314977012524871808299871583739120337013670764137822600494719295695509962048076369003300582608221512890977179218403490618248182742346257053423098191543876380038142229449397905048214079409552005533109779124031202251087019604943776614843249858137658267554969467259670489827949796870173084083147526013869475998709291011388716198629036984483487291360878933787067035264247529970281622256744505504407870085203458656047874232853206777920877228814082561416004910392338226033641329180938760363591802807801856500694617081075856682649889542886440683712166192421319757139675758814894418944509416293146239774560314534007586089366345853330544106370312774633895627755096982115752027762912317905619918288763255395057113",0);

	printf("\nplain text:\n--------------\n");	
	printf("\nm: ");	
	mpz_out_str(stdout, 16, m); puts("");


	doub_mult_algo(c,pubk.e,pubk.n, m);
	printf("\ncipher text:\n--------------\n");	
	printf("\nc.x: ");	
	mpz_out_str(stdout, 16, c); puts("");

	doub_mult_algo(m2,pivk.d,pubk.n, c);
	printf("\nplain text:\n--------------\n");	
	printf("\nm2:: ");	
	mpz_out_str(stdout, 16, m2); puts("");


	printf("\nCompute Timing for Encryption:\n--------------\n");	

	for(i=0;i<5;i++)
	{
		iterations=0;
		start=clock();

		do {
			doub_mult_algo(c,pubk.e,pubk.n, m);

			iterations++;
			elapsed=(double)(clock()-start)/(double)CLOCKS_PER_SEC;
			//printf(" %8.10lf elapsed\n",elapsed);
		} while (elapsed<MIN_TIME || iterations<MIN_ITERS);

		elapsed=1000*elapsed/(double)iterations;
		//printf("R - %8d iterations\n",iterations);
		printf( " %8.10lf ms (milli seconds) per iteration\n",elapsed);
	}

	printf("\nCompute Timing for Decryption:\n--------------\n");	

	for(i=0;i<5;i++)
	{
		iterations=0;
		start=clock();

		do {
			doub_mult_algo(m2,pivk.d,pubk.n, c);

			iterations++;
			elapsed=(double)(clock()-start)/(double)CLOCKS_PER_SEC;
		} while (elapsed<MIN_TIME || iterations<MIN_ITERS);

		elapsed=1000*elapsed/(double)iterations;
		printf( " %8.10lf ms (milli seconds) per iteration\n",elapsed);
	}


	mpz_clear(pubk.e);
	mpz_clear(pubk.n);

	mpz_clear(m);
	mpz_clear(m2);
	mpz_clear(pivk.d);
	mpz_clear(c);
}
